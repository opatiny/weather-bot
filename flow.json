[{"id":"53b5f7f.762b708","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"8953fd2e.47f7a","type":"telegram bot","z":"","botname":"@annoyingWeatherMasterBot","usernames":"","chatids":"","baseapiurl":"","updatemode":"polling","pollinterval":"300","usesocks":false,"sockshost":"","socksport":"6667","socksusername":"anonymous","sockspassword":"","bothost":"","localbotport":"8443","publicbotport":"8443","privatekey":"","certificate":"","useselfsignedcertificate":false,"sslterminated":false,"verboselogging":false},{"id":"b873447f.4b4f68","type":"telegram receiver","z":"53b5f7f.762b708","name":"Bot Receive","bot":"8953fd2e.47f7a","saveDataDir":"","filterCommands":false,"x":90,"y":40,"wires":[["5b1a035b.d51f6c","d7a5d117.4f383"],[]]},{"id":"5658f6cf.9a5548","type":"http request","z":"53b5f7f.762b708","name":"","method":"GET","ret":"obj","paytoqs":true,"url":"https://api.openweathermap.org/data/2.5/{{{urlType}}}?","tls":"","persist":false,"proxy":"","authType":"basic","x":150,"y":260,"wires":[["55920178.1df78","973ed437.6b4148"]]},{"id":"55920178.1df78","type":"debug","z":"53b5f7f.762b708","name":"","active":true,"console":"false","complete":"payload","x":350,"y":240,"wires":[]},{"id":"f1aef7e4.d65458","type":"function","z":"53b5f7f.762b708","name":"messageGenerator","func":"msg.payload = {};\n\nif (msg.errors.length) {\n    msg.content = msg.errors.join('\\n');\n}\n\nmsg.payload.chatId = msg.id;\nmsg.payload.type = 'message';\nmsg.payload.content = msg.content;\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":340,"wires":[["72c9347.19434cc"]]},{"id":"72c9347.19434cc","type":"telegram sender","z":"53b5f7f.762b708","name":"Weather message","bot":"8953fd2e.47f7a","x":630,"y":400,"wires":[[]]},{"id":"5b1a035b.d51f6c","type":"function","z":"53b5f7f.762b708","name":"handleInputMessage","func":"msg.command = '';\nmsg.forecast = 0;\nmsg.errors = []; // array of strings\nmsg.urlType = '';\nmsg.id = msg.payload.chatId;\nmsg.city = 'Denges';\nmsg.help = false;\n\nlet input = msg.payload.content.split(' ');\nmsg.command = input[0];\nif (msg.command === '/help' || msg.command === '/start') {\n    msg.help = true;\n    return msg;\n}\n\nlet value = Number(input[1]);\n\nif (input[1]) { // forecast\n    if(isNaN(value)) {\n        msg.errors.push(`Error: The value entered after command ${input[0]} must be a number.`)\n    } else {\n        msg.forecast = value;\n    }\n} else { // weather\n    msg.forecast = 0;\n}\n\nconsole.log(msg.errors);\n\n\nif(msg.forecast || msg.command === '/nextday') {\n    msg.urlType = \"forecast\";\n} else {\n    msg.urlType = \"weather\";\n}\n\nif(msg.command === '/city') {\n    if (input[2] !== undefined) {\n        msg.city = input [2];\n    } else {\n        msg.errors.push('Error: You did not input a city name as the second argument.')\n    }\n}\n\nmsg.payload = {\n    \"q\": msg.city,\n    \"appid\": \"7f4ac11ab23ea236c76e1ffb747bd0fa\",\n    \"units\": \"metric\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":160,"y":120,"wires":[["e87a8870.3c61d8"]]},{"id":"d7a5d117.4f383","type":"debug","z":"53b5f7f.762b708","name":"","active":true,"console":"false","complete":"payload","x":290,"y":40,"wires":[]},{"id":"973ed437.6b4148","type":"switch","z":"53b5f7f.762b708","name":"urlType switch","property":"urlType","propertyType":"msg","rules":[{"t":"eq","v":"weather","vt":"str"},{"t":"eq","v":"forecast","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":140,"y":340,"wires":[["23b242c7.2f1cce"],["f3dacc8e.b8259"]]},{"id":"23b242c7.2f1cce","type":"function","z":"53b5f7f.762b708","name":"handleWeatherData","func":"let content = '';\n\n  switch (msg.command) {\n    case '/temp':\n      content = `Current temperature in Denges is ${msg.payload.main.temp}°C.`;\n      break;\n    case '/tempfeel':\n      content = `Current perceived temperature in Denges is ${msg.payload.main.feels_like}°C.`;\n      break;\n    case '/humidity':\n      content = `Current humidity in Denges is ${msg.payload.main.humidity}%.`;\n      break;\n    case '/wind':\n      content = `Current wind speed in Denges is ${msg.payload.wind.speed}m/s.`;\n      break;\n    case '/weather':\n      content = `Current weather in Denges is ${msg.payload.weather[0].description}.`;\n      break;\n    case '/clouds':\n      content = `Current amount of sky cloudy in Denges is ${msg.payload.clouds.all}%.`;\n      break;\n    case '/rain':\n      content = `Amount of rain fallen during last hour in Denges is ${msg.payload.rain ? msg.payload.rain['1h'] : 0}mm.`;\n      break;\n    case '/city':\n    case '/all':\n      content = \n        `Current weather in ${msg.city}\\n\n        Temperature: ${msg.payload.main.temp}°C\n        Perceived temperature: ${msg.payload.main.feels_like}°C\n        Humidity: ${msg.payload.main.humidity}%\n        Wind speed: ${msg.payload.wind.speed}m/s\n        Weather description: ${msg.payload.weather[0].description}\n        Cloudiness: ${msg.payload.clouds.all}%\n        Rain (last hour): ${msg.payload.rain ? msg.payload.rain['1h'] : 0}mm`;\n      break;\n    default:\n      msg.errors.push('Error: Unknown command for current weather in bot v1!');\n      break;\n  }\n\n  msg.content = content;\n\n  return msg;","outputs":1,"noerr":0,"x":340,"y":320,"wires":[["f1aef7e4.d65458"]]},{"id":"f3dacc8e.b8259","type":"function","z":"53b5f7f.762b708","name":"handleForecastData","func":"let content = \"\";\n\nif (msg.forecast > 120) {\n    msg.errors.push('Error: You are asking for a forecast in more than 120 hours.');\n    return msg;\n}\nlet index = Math.floor(msg.forecast/3);\n\nswitch (msg.command) {\n    case (\"/temp\"):\n        content = `The temperature in Denges in ${msg.forecast} hours will be ${msg.payload.list[index].main.temp}°C.`\n        break;\n    case '/tempfeel':\n      content = `The perceived temperature in Denges in ${msg.forecast} hours will be ${msg.payload.list[index].main.feels_like}°C.`;\n      break;\n    case '/humidity':\n      content = `The humidity in Denges in ${msg.forecast} hours will be ${msg.payload.list[index].main.humidity}%.`;\n      break;\n    case '/wind':\n      content = `The wind speed in Denges in ${msg.forecast} hours will be ${msg.payload.list[index].wind.speed}m/s.`;\n      break;\n    case '/weather':\n      content = `The weather in Denges in ${msg.forecast} hours will be ${msg.payload.list[index].weather[0].description}.`;\n      break;\n    case '/clouds':\n      content = `The amount of sky cloudy in Denges in ${msg.forecast} hours will be ${msg.payload.list[index].clouds.all}%.`;\n      break;\n    case '/rain':\n      content = `The amount of rain fallen that will fall over three hours in Denges in ${msg.forecast} hours will be ${msg.payload.list[index].rain ? msg.payload.list[index].rain['3h'] : 0}mm.`;\n      break;\n    case '/city':\n    case '/all':\n      content = \n        `Predicted weather in ${msg.city} in ${msg.forecast} hours\\n\n        Temperature: ${msg.payload.list[index].main.temp}°C\n        Perceived temperature: ${msg.payload.list[index].main.feels_like}°C\n        Humidity: ${msg.payload.list[index].main.humidity}%\n        Wind speed: ${msg.payload.list[index].wind.speed}m/s\n        Weather description: ${msg.payload.list[index].weather[0].description}\n        Cloudiness: ${msg.payload.list[index].clouds.all}%\n        Rain (next three hours): ${msg.payload.list[index].rain ? msg.payload.list[index].rain['3h'] : 0}mm`;\n      break;\n    case '/nextday':\n      content = \n        `Predicted weather in ${msg.city} for the next 24h \\n (3 hours time slots) \\n\\n Temperature Perceived temperature   Weather \\n`\n        for (let i = 0; i<7; i++) {\n            content += `${msg.payload.list[i].main.temp.toFixed(2)}°C ${msg.payload.list[i].main.feels_like.toFixed(2)}°C    ${msg.payload.list[i].weather[0].description}\\n`\n        }\n      break;\n    default:\n      msg.errors.push('Error: Unknown command for forecast in bot v1!');\n      break;\n}\n\nmsg.content = content\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":360,"wires":[["f1aef7e4.d65458"]]},{"id":"e87a8870.3c61d8","type":"switch","z":"53b5f7f.762b708","name":"help switch","property":"help","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":170,"y":180,"wires":[["80317337.a242d"],["5658f6cf.9a5548"]]},{"id":"80317337.a242d","type":"function","z":"53b5f7f.762b708","name":"messageGenerator","func":"msg.payload = {};\n\ncontent = `**List of commands:**\\n\n/temp - Measured temperature\n/tempfeel - Human perceived temperature\n/wind - Wind speed\n/weather - Weather description -> clear, cloudy, rain, ...\n/clouds - Percentage of sky covered with clouds\n/rain - Amount of rain fallen\n/humidity - Humidity in percents\n/all - Get all information given by other commands at once.\n/city - Get all information like with \"/all\" for another city than Denges. City name should be only in lowercase letters.\n/nextday - Temperature, perceived temperature and weather description for the next 24h in Denges\n/help - Information about all available commands\n\n\n- All commands excepted /city, /nextday and /help can be followed by a number (we call it time offset), which indicates for when the weather prediction must be (number of hours in the future from now). The maximal value of this number is 120 hours aka 5 days. If no time offset is used, current info is returned.\n\n\n- /help and /nextday accept no parameters.\n\n- /city must have two parameters. First the time offset, then the name of the city for which you want the forecast, all in lowercase.`;\n\n\nmsg.payload.chatId = msg.id;\nmsg.payload.type = 'message';\nmsg.payload.content = content;\nmsg.payload.options = { \n        parse_mode: \"Markdown\"\n    }\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":180,"wires":[["ae02658c.e55328"]]},{"id":"ae02658c.e55328","type":"telegram sender","z":"53b5f7f.762b708","name":"Help message","bot":"8953fd2e.47f7a","x":620,"y":180,"wires":[[]]}]